{% extends 'usuarios/baseU.html' %}
{% load humanize %}
{% load static %}
{% block title %}Dashboard Administrador{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'usuarios/css/panel-contacto-dashboard.css' %}">
{% endblock %}

{% block content %}
<body data-page="dashboard"></body>

<div class="contenedor-dashboard">
  <h1>Dashboard Administrador</h1>
  <form method="GET" class="filtro-tiempo">
    <label class="label-filtro">Filtrar por:</label>
    <div class="filtro-group">
      <label class="filtro-label-ventas" for="mesFilter">Mes</label>
      <select id="mesFilter" name="mes_especifico" class="select-filter-ventas">
          <option value="">Todos los meses</option>
          <option value="01" {% if request.GET.mes_especifico == "01" %}selected{% endif %}>Enero</option>
          <option value="02" {% if request.GET.mes_especifico == "02" %}selected{% endif %}>Febrero</option>
          <option value="03" {% if request.GET.mes_especifico == "03" %}selected{% endif %}>Marzo</option>
          <option value="04" {% if request.GET.mes_especifico == "04" %}selected{% endif %}>Abril</option>
          <option value="05" {% if request.GET.mes_especifico == "05" %}selected{% endif %}>Mayo</option>
          <option value="06" {% if request.GET.mes_especifico == "06" %}selected{% endif %}>Junio</option>
          <option value="07" {% if request.GET.mes_especifico == "07" %}selected{% endif %}>Julio</option>
          <option value="08" {% if request.GET.mes_especifico == "08" %}selected{% endif %}>Agosto</option>
          <option value="09" {% if request.GET.mes_especifico == "09" %}selected{% endif %}>Septiembre</option>
          <option value="10" {% if request.GET.mes_especifico == "10" %}selected{% endif %}>Octubre</option>
          <option value="11" {% if request.GET.mes_especifico == "11" %}selected{% endif %}>Noviembre</option>
          <option value="12" {% if request.GET.mes_especifico == "12" %}selected{% endif %}>Diciembre</option>
      </select>
    </div>

    <div class="filtro-group">
      <label class="filtro-label-ventas" for="anioFilter">Año</label>
      <select id="anioFilter" name="anio_especifico" class="select-filter-ventas">
          <option value="">Todos los años</option>
          <option value="2025" {% if request.GET.anio_especifico == "2025" %}selected{% endif %}>2025</option>
      </select>
    </div>

    <button type="submit" class="btn-filtro">Aplicar</button>

    <a href="{% url 'usuarios:exportar_dashboard_excel' %}?{{ request.GET.urlencode }}" class="btn-excel">
        Exportar a Excel
    </a>
  </form>
  <div class="cards">
    <div class="card" data-url="{% url 'usuarios:informe_ventas' %}">
      <h2>Ventas</h2>
      <p>${{ total_ventas|intcomma }}</p>
    </div>
    <div class="card" data-url="{% url 'productos:list_product' %}">
      <h2>Productos</h2>
      <p>{{ total_productos }}</p>
    </div>
    <div class="card" data-url="{% url 'usuarios:gstUsuarios' %}">
      <h2>Usuarios</h2>
      <p>{{ total_usuarios }}</p>
    </div>
    <div class="card" data-url="{% url 'usuarios:pedidos' %}">
      <h2>Pedidos</h2>
      <p>{{ total_pedidos }}</p>
    </div>
  </div>

  <div class="sections">
    <div class="section">
      <h3>Ventas por Mes</h3>
      <ul>
        {% for mes, valor in ventas_info %}
        <li>{{ mes }} — ${{ valor|intcomma }}</li>
        {% empty %}
        <li>No hay ventas registradas.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <h3>Estado de Pedidos</h3>
      <ul>
        {% for estado, cantidad in estado_info %}
        <li>{{ estado }} — {{ cantidad }}</li>
        {% empty %}
        <li>No hay pedidos registrados.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <h3>Productos Más Vendidos</h3>
      <ul>
        {% for prod in prod_info %}
        <li>{{ prod.nombProduc }} — {{ prod.total_vendidos }} vendidos</li>
        {% empty %}
        <li>No hay productos vendidos.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <h3>Usuarios con Más Compras</h3>
      <ul>
        {% for user in usuarios_info %}
        <li>{{ user.nombre }} — {{ user.pedidos_pagados }} pedidos</li>
        {% empty %}
        <li>No hay usuarios con compras registradas.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="section devoluciones-largas">
    <h3>Últimas 5 Devoluciones</h3>

    {% if ultimas_devoluciones %}
    <ul>
        {% for dev in ultimas_devoluciones %}
            <li>
                <strong>{{ dev.producto.nombProduc }}</strong><br>
                {{ dev.cantidad }} unidades — Motivo: {{ dev.motivo }}
            </li>
        {% endfor %}
    </ul>
    {% else %}
        <p>No hay devoluciones registradas.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static '/usuarios/js/main.js' %}"></script>
{% endblock %}