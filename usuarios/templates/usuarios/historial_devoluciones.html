{% extends 'usuarios/baseU.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'usuarios/css/devoluciones-usuarios.css' %}" />
{% endblock %}

{% block page_id %}historial-devoluciones{% endblock %}

{% block content %}
<div class="contenedor-admin-devoluciones">
    <h2>Historial de Devoluciones</h2>

    <!-- Filtros -->
    <div class="filtros-wrapper">
        <form method="GET" class="filtros-devoluciones">
            <div class="filtro-grupo">
                <label class="label-devoluciones" >Buscar:</label>
                <input type="text" name="buscar" placeholder="Usuario, producto o lote..." 
                       value="{{ busqueda|default:'' }}" class="input-buscar">
            </div>

            <div class="filtro-grupo">
                <label class="label-devoluciones" >Estado:</label>
                <select name="estado">
                    <option value="">Todos</option>
                    <option value="Aprobada" {% if estado_filtro == 'Aprobada' %}selected{% endif %}>Aprobada</option>
                    <option value="Rechazada" {% if estado_filtro == 'Rechazada' %}selected{% endif %}>Rechazada</option>
                </select>
            </div>

            <div class="filtro-grupo">
                <label class="label-devoluciones" >Tiempo:</label>
                <select name="tiempo">
                    <option value="">Todos</option>
                    <option value="semana" {% if filtro_tiempo == 'semana' %}selected{% endif %}>Esta semana</option>
                    <option value="mes" {% if filtro_tiempo == 'mes' %}selected{% endif %}>Este mes</option>
                    <option value="año" {% if filtro_tiempo == 'año' %}selected{% endif %}>Este año</option>
                </select>
            </div>

            <button type="submit" class="btn-filtrar-devoluciones">
                <i class="fa fa-filter"></i> Filtrar
            </button>
            <a href="{% url 'usuarios:historial_devoluciones' %}" class="btn-limpiar-filtros">
                <i class="fa fa-times"></i> Limpiar
            </a>
        </form>

        <a href="{% url 'usuarios:exportar_devoluciones_excel' %}?estado={{ estado_filtro|default:'' }}&tiempo={{ filtro_tiempo|default:'' }}&buscar={{ busqueda|default:'' }}" class="btn-exportar-historial">
            <i class="fa fa-file-excel"></i> Exportar a Excel
        </a>
    </div>

    <!-- Estadísticas -->
    <div class="stats-devoluciones">
        <div class="stat-card aprobadas">
            <i class="fa fa-check-circle"></i>
            <span class="stat-numero">{{ total_aprobadas }}</span>
            <span class="stat-label">Aprobadas</span>
        </div>
        <div class="stat-card rechazadas">
            <i class="fa fa-times-circle"></i>
            <span class="stat-numero">{{ total_rechazadas }}</span>
            <span class="stat-label">Rechazadas</span>
        </div>
    </div>

    {% if devoluciones %}
    <table class="tabla-historial">
        <thead>
            <tr>
                <th>#ID</th>
                <th>Cliente</th>
                <th>Producto</th>
                <th>Lote</th>
                <th>Estado</th>
                <th>Fecha Solicitud</th>
                <th>Admin</th>
                <th>Comentario</th>
            </tr>
        </thead>
        <tbody>
            {% for devolucion in devoluciones %}
            <tr class="{% if devolucion.estado == 'Aprobada' %}fila-aprobada{% else %}fila-rechazada{% endif %}">
                <td>#{{ devolucion.id }}</td>
                <td>
                    <strong>{{ devolucion.usuario.nombre }}</strong><br>
                    <small>{{ devolucion.usuario.email }}</small>
                </td>
                <td>{{ devolucion.producto.nombProduc }}</td>
                <td>
                    {% if devolucion.lote %}
                        {{ devolucion.lote.codigo_lote }}
                    {% else %}
                        <span class="sin-lote">SIN LOTE</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge-estado {% if devolucion.estado == 'Aprobada' %}badge-aprobada{% else %}badge-rechazada{% endif %}">
                        {{ devolucion.estado }}
                    </span>
                </td>
                <td>{{ devolucion.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                {% with ultimo_historial=devolucion.historial.first %}
                    <td>{{ ultimo_historial.usuario_admin.nombre|default:"N/A" }}</td>
                    <td>{{ devolucion.motivo|default:"Sin motivo especificado" }}</td>
                {% endwith %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-devoluciones">
        <i class="fa fa-inbox"></i>
        <p>No hay historial de devoluciones</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% endblock %}